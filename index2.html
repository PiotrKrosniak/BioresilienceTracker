<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World Map Zoom Demo</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <!-- Data and helpers reused from the original index.html implementation -->
  <script src="ScoreCardData.js" defer></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    svg { width: 100vw; height: 100vh; background: #f4f4f4; }
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 12px;
      display: none;
      pointer-events: none;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    table {
      border-collapse: collapse;
      margin-top: 6px;
      width: 100%;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    
    /* New styles for country detail view */
    .country-detail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
    }
    
    .country-detail.active {
      opacity: 1;
      visibility: visible;
    }
    
    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      z-index: 1001;
      opacity: 0;
      transform: translateX(-20px);
      transition: opacity 0.6s ease-out 0.4s, transform 0.6s ease-out 0.4s;
    }
    
    .back-button.active {
      opacity: 1;
      transform: translateX(0);
    }
    
    .back-button:hover {
      background: #0056b3;
    }
    
    .country-info {
      margin-top: 80px;
      text-align: center;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.8s ease-out 0.2s, transform 0.8s ease-out 0.2s;
    }
    
    .country-info.active {
      opacity: 1;
      transform: translateY(0);
    }
    
    .country-name {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 30px;
      color: #333;
    }
    
    .country-table {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .country-table table {
      width: 100%;
      border: none;
      table-layout: fixed; /* Fixed table layout for better control */
    }
    
    .country-table th {
      background: #f5f5f5;
      padding: 15px;
      font-weight: bold;
      color: #333;
      border: none;
      border-bottom: 2px solid #dee2e6;
      font-size: 14px;
      width: 20%; /* Match index.html first column width */
    }
    
    .country-table td {
      padding: 15px;
      border: none;
      border-bottom: 1px solid #dee2e6;
      font-size: 13px;
      white-space: normal; /* Allow text to wrap naturally */
      word-wrap: break-word; /* Break long words/URLs */
      overflow-wrap: break-word; /* Modern browser support */
      max-width: 0; /* Force text wrapping in table cells */
      background: #fff;
      vertical-align: top;
    }
    
    /* Apply two-column width only to specific tables, not the 4-col health table */
    #general-table td:last-child,
    #economy-table td:last-child,
    #demographics-table td:last-child {
      width: 80%;
      white-space: pre-wrap; /* Preserve newlines and wrap long lines */
    }
    
    /* Custom scrollbar styling for table cells */
    .country-table td::-webkit-scrollbar {
      width: 6px;
    }
    
    .country-table td::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .country-table td::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    .country-table td::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    /* First column styling handled by th above */
    /* Disable hover effect */
    .country-table tr:hover {
       background: inherit;
    }
    
    /* Tab styles */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 0; /* Remove bottom margin */
      border-bottom: 2px solid #e9ecef;
    }
    
    .tab {
      padding: 12px 24px;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6c757d;
      border-radius: 8px 8px 0 0;
      margin-right: 4px;
      transition: all 0.3s ease;
    }
    
    .tab:hover {
      background: #e9ecef;
      color: #495057;
    }
    
    .tab.active {
      background: #007bff;
      color: white;
    }
    
    .tab-content {
      display: none;
      margin-top: 0; /* Remove top margin */
      max-height: 60vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable both-edges;
    }

    /* Visible custom scrollbar for tab content */
    .tab-content::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    .tab-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    .tab-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 6px;
    }
    .tab-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    /* Health table overrides */
    #health-table th { width: auto; }
    
    .tab-content.active {
      display: block;
    }
    
    /* Country contour styles */
    .country-contour {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      width: 300px;
      height: 300px;
      z-index: 999;
      opacity: 0;
      transition: transform 0.8s ease-out, opacity 0.8s ease-out;
    }
    
    .country-contour.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    .country-contour svg {
      width: 100%;
      height: 100%;
      background: transparent;
    }
    
    .country-contour path {
      fill: #e3f2fd;
      stroke: #1976d2;
      stroke-width: 2;
    }
    
    /* Organization filter buttons */
    .org-buttons {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 1002;
    }
    
    .org-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #007bff;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #007bff;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .org-button:hover {
      background: #007bff;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .org-button.active {
      background: #007bff;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
  </style>
</head>
<body>
  <div id="tooltip" class="tooltip"></div>
  
  <!-- Organization filter buttons -->
  <div class="org-buttons">
    <button class="org-button" data-org="nato">NATO</button>
    <button class="org-button" data-org="eu">European Union</button>
  </div>
  
  <svg id="world-map"></svg>
  
  <!-- Map Legend -->
  <div id="map-legend" style="position: absolute; top: 80px; left: 20px; background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-family: sans-serif; font-size: 14px; z-index: 1000;">
    <h4 style="margin: 0 0 10px 0; color: #333;">Map Legend</h4>
    <div style="display: flex; align-items: center; margin-bottom: 8px;">
      <div style="width: 20px; height: 20px; background: #4CAF50; border: 2px solid #2E7D32; margin-right: 10px; border-radius: 3px;"></div>
      <span>Countries with data</span>
    </div>
    <div style="display: flex; align-items: center;">
      <div style="width: 20px; height: 20px; background: #dcdcdc; border: 1px solid #555; margin-right: 10px; border-radius: 3px;"></div>
      <span>Countries without data</span>
    </div>
  </div>
  
  <!-- Country detail view -->
  <div id="country-detail" class="country-detail">
    <button class="back-button" onclick="showWorldMap()">← Back to World Map</button>
    
    <!-- Country contour -->
    <div id="country-contour" class="country-contour"></div>
    
    <div class="country-info">
      <div id="country-name" class="country-name"></div>
      <div class="country-table">
        <div class="tabs">
          <div class="tab active" data-tab="general">Biosecurity Overview</div>
          <div class="tab" data-tab="economy">National Capabilities Map</div>
          <div class="tab" data-tab="demographics">Bioresilience Assessment</div>
          <div class="tab" data-tab="health">Government Tracked Biological Incidents</div>
        </div>
        
        <div class="tab-content active" id="general-content">
          <table id="general-table">
            <thead>
             
            </thead>
            <tbody id="general-data-body">
            </tbody>
          </table>
        </div>
        
        <div class="tab-content" id="economy-content">
          <table id="economy-table">
            <thead></thead>
            <tbody id="economy-data-body">
            </tbody>
          </table>
        </div>
        
        <div class="tab-content" id="demographics-content">
          <table id="demographics-table">
            <thead></thead>
            <tbody id="demographics-data-body">
            </tbody>
          </table>
        </div>
        
        <div class="tab-content" id="health-content">
          <table id="health-table">
            <thead></thead>
            <tbody id="health-data-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const svg = d3.select("#world-map");
    const width = window.innerWidth;
    const height = window.innerHeight;
    const g = svg.append("g");
    const tooltip = d3.select("#tooltip");
    const countryDetail = d3.select("#country-detail");

    const projection = d3.geoMercator().scale(130).translate([width / 2, height / 1.5]);
    const path = d3.geoPath().projection(projection);

    // Organization membership data
    const organizationData = {
      nato: [
        "Albania", "Belgium", "Bulgaria", "Canada", "Croatia", "Czech Republic", 
        "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", 
        "Iceland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Montenegro", 
        "Netherlands", "North Macedonia", "Norway", "Poland", "Portugal", "Romania", 
        "Slovakia", "Slovenia", "Spain", "Sweden", "Turkey", "United Kingdom", "United States of America"
      ],
      eu: [
        "Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", 
        "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", 
        "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", 
        "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden"
      ]
    };

   

    // Load world geoJSON
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(worldData => {
      const countries = topojson.feature(worldData, worldData.objects.countries).features;

      const countryNames = new Map(); // Mapping country ids to names
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(namesData => {
        countries.forEach(d => {
          d.name = d.properties.name || "Unknown";
        });
      });

      // Fetch available ISOs and highlight countries with data
      fetchAvailableIsos().then(availableIsos => {
        
        g.selectAll("path")
          .data(countries)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", function(d) {
            // Check if this country has data by comparing ISO codes
            const countryName = d.properties.name;
            
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            return hasData ? "#4CAF50" : "#dcdcdc"; // Green for countries with data, gray for those without
          })
          .attr("stroke", function(d) {
            const countryName = d.properties.name;
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            return hasData ? "#2E7D32" : "#555"; // Darker green for countries with data, dark gray for those without
          })
          .attr("stroke-width", function(d) {
            const countryName = d.properties.name;
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            return hasData ? 1.5 : 1; // Thicker border for countries with data
          })
          .on("click", function(event, d) {
            const countryName = d.properties.name;
            // Always show country detail - data will be fetched dynamically
            showCountryDetail(countryName);
          });
      });
      
      // Store countries reference for filtering
      window.countries = countries;
    });

    // Add organization button functionality
    d3.selectAll(".org-button").on("click", function() {
      const org = this.getAttribute("data-org");
      const isActive = d3.select(this).classed("active");
      
      // Toggle button state
      d3.selectAll(".org-button").classed("active", false);
      if (!isActive) {
        d3.select(this).classed("active", true);
      }
      
      // Update map colors based on organization
      updateMapColors(org, !isActive);
      
      // Update legend based on organization filter
      updateLegend(org, !isActive);
    });

    // Function to update the legend based on active filters
    function updateLegend(org, show) {
      const legend = d3.select("#map-legend");
      
      if (!show || !org) {
        // Reset to default legend
        legend.html(`
          <h4 style="margin: 0 0 10px 0; color: #333;">Map Legend</h4>
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background: #4CAF50; border: 2px solid #2E7D32; margin-right: 10px; border-radius: 3px;"></div>
            <span>Countries with data</span>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 20px; height: 20px; background: #dcdcdc; border: 1px solid #555; margin-right: 10px; border-radius: 3px;"></div>
            <span>Countries without data</span>
          </div>
        `);
      } else {
        // Show organization-specific legend
        const orgName = org === "nato" ? "NATO" : "European Union";
        const orgColor = org === "nato" ? "#4CAF50" : "#2196F3";
        const orgBorderColor = org === "nato" ? "#2E7D32" : "#1976D2";
        
        legend.html(`
          <h4 style="margin: 0 0 10px 0; color: #333;">Map Legend</h4>
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background: ${orgColor}; border: 2px solid ${orgBorderColor}; margin-right: 10px; border-radius: 3px;"></div>
            <span>${orgName} members</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <div style="width: 20px; height: 20px; background: #FF9800; border: 2px solid #E65100; margin-right: 10px; border-radius: 3px;"></div>
            <span>Countries with data (not in ${orgName})</span>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 20px; height: 20px; background: #dcdcdc; border: 1px solid #555; margin-right: 10px; border-radius: 3px;"></div>
            <span>Countries without data</span>
          </div>
        `);
      }
    }

    function updateMapColors(org, show) {
      if (!show || !org) {
        // Reset to default colors but preserve data highlighting
        fetchAvailableIsos().then(availableIsos => {
          g.selectAll("path")
            .attr("fill", function(d) {
              const countryName = d.properties.name;
              const hasData = checkIfCountryHasData(countryName, availableIsos);
              return hasData ? "#4CAF50" : "#dcdcdc";
            })
            .attr("stroke", function(d) {
              const countryName = d.properties.name;
              const hasData = checkIfCountryHasData(countryName, availableIsos);
              return hasData ? "#2E7D32" : "#555";
            })
            .attr("stroke-width", function(d) {
              const countryName = d.properties.name;
              const hasData = checkIfCountryHasData(countryName, availableIsos);
              return hasData ? 1.5 : 1;
            });
        });
        return;
      }
      
      const memberCountries = organizationData[org];
      
      fetchAvailableIsos().then(availableIsos => {
        g.selectAll("path")
          .attr("fill", function(d) {
            const countryName = d.properties.name;
            const isMember = memberCountries.includes(countryName);
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            
            if (isMember) {
              // Organization members get priority colors
              return org === "nato" ? "#4CAF50" : "#2196F3"; // Green for NATO, Blue for EU
            } else if (hasData) {
              // Countries with data but not in organization
              return "#FF9800"; // Orange for countries with data but not in org
            } else {
              // Countries without data and not in organization
              return "#dcdcdc";
            }
          })
          .attr("stroke", function(d) {
            const countryName = d.properties.name;
            const isMember = memberCountries.includes(countryName);
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            
            if (isMember) {
              return org === "nato" ? "#2E7D32" : "#1976D2"; // Darker green/blue for borders
            } else if (hasData) {
              return "#E65100"; // Darker orange for borders
            } else {
              return "#555";
            }
          })
          .attr("stroke-width", function(d) {
            const countryName = d.properties.name;
            const isMember = memberCountries.includes(countryName);
            const hasData = checkIfCountryHasData(countryName, availableIsos);
            
            if (isMember || hasData) {
              return 1.5; // Thicker border for highlighted countries
            } else {
              return 1;
            }
          });
      });
    }

    function showCountryDetail(countryName) {
      // Set country name
      d3.select("#country-name").text(countryName);
      
      // Create country contour
      createCountryContour(countryName);
      
      // Populate data for all tabs
      // Dynamically fetch ISO codes and populate all tabs
      fetchAndPopulateCountryData(countryName);
       
      // Add tab switching functionality
      setupTabSwitching();
      
      // Smooth transition to country detail view
      svg.transition()
        .duration(600)
        .style("opacity", 0)
        .on("end", function() {
          svg.style("display", "none");
          
          // Show country detail view with smooth transition
          countryDetail.style("display", "block");
          
          // Trigger animations with slight delays for staggered effect
          setTimeout(() => {
            countryDetail.classed("active", true);
          }, 50);
          
          setTimeout(() => {
            d3.select("#country-contour").classed("active", true);
          }, 200);
          
          setTimeout(() => {
            d3.select(".country-info").classed("active", true);
          }, 400);
          
          setTimeout(() => {
            d3.select(".back-button").classed("active", true);
          }, 600);
        });
    }

    function createCountryContour(countryName) {
      // Clear existing contour
      d3.select("#country-contour").html("");
      
      // Find the country data from the world map
      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries).features;
        const selectedCountry = countries.find(d => d.properties.name === countryName);
        
        if (selectedCountry) {
          // Create a new SVG for the contour
          const contourSvg = d3.select("#country-contour")
            .append("svg")
            .attr("width", 300)
            .attr("height", 300);
          
          // Create a projection for the contour (centered on the country)
          const [[x0, y0], [x1, y1]] = path.bounds(selectedCountry);
          const dx = x1 - x0;
          const dy = y1 - y0;
          const x = (x0 + x1) / 2;
          const y = (y0 + y1) / 2;
          const scale = Math.min(250 / dx, 250 / dy);
          const translate = [150 - scale * x, 150 - scale * y];
          
          // Create a new path generator for the contour
          const contourProjection = d3.geoMercator()
            .scale(scale * 130)
            .translate(translate);
          const contourPath = d3.geoPath().projection(contourProjection);
          
          // Draw the country contour
          contourSvg.append("path")
            .datum(selectedCountry)
            .attr("d", contourPath)
            .attr("fill", "#e3f2fd")
            .attr("stroke", "#1976d2")
            .attr("stroke-width", 2);
        }
      });
    }

    function populateTabData(countryName, hasData) {
      const tabCategories = ['general', 'economy', 'demographics', 'health'];
      
      tabCategories.forEach(category => {
        const tableBody = d3.select(`#${category}-data-body`);
        tableBody.html("");
        
        if (hasData && countryData[countryName] && countryData[countryName][category]) {
          // Add data rows for this category
          countryData[countryName][category].forEach(row => {
            const tr = tableBody.append("tr");
            const labelContent = useDHtml && row.html && row.html.includes('<a') ? row.html : (row.label || row.text || '-');
            tr.append("td").html(labelContent);
            const baseHtml = useDHtml ? (row.dHtml || row.dText || row.html || row.text || "-") : (row.html || row.text || "-");
            tr.append("td").html(baseHtml);
          });
        } else {
          // Show placeholder data for countries without specific data
          const placeholderData = [
            { metric: "Data", value: "Not available" },
            { metric: "Information", value: "Not available" },
            { metric: "Statistics", value: "Not available" }
          ];
          
          placeholderData.forEach(row => {
            const tr = tableBody.append("tr");
            tr.append("td").text(row.metric);
            tr.append("td").text(row.value);
          });
        }
      });
    }

    function setupTabSwitching() {
      // Remove existing event listeners
      d3.selectAll(".tab").on("click", null);
      
      // Add new event listeners
      d3.selectAll(".tab").on("click", function() {
        const tabName = this.getAttribute("data-tab");
        
        // Remove active class from all tabs and content
        d3.selectAll(".tab").classed("active", false);
        d3.selectAll(".tab-content").classed("active", false);
        
        // Add active class to clicked tab and corresponding content
        d3.select(this).classed("active", true);
        d3.select(`#${tabName}-content`).classed("active", true);
      });
    }

    function showWorldMap() {
      // Remove active classes to trigger exit animations
      countryDetail.classed("active", false);
      d3.select("#country-contour").classed("active", false);
      d3.select(".country-info").classed("active", false);
      d3.select(".back-button").classed("active", false);
      
      // Wait for exit animations to complete, then show world map
      setTimeout(() => {
        countryDetail.style("display", "none");
        
        // Show world map with fade-in effect
        svg.style("display", "block")
          .style("opacity", 0);
        
        svg.transition()
          .duration(600)
          .style("opacity", 1)
          .on("end", function() {
            // Reset zoom with smooth transition
            g.transition()
              .duration(750)
              .attr("transform", "translate(0,0) scale(1)");
          });
      }, 600);
    }

    function showTooltip(x, y, country) {
      const name = country.properties.name;
      const data = countryData[name];
      if (!data) return;

      let html = `<strong>${name}</strong><br>Share: ${data.share}<br><br>`;
      html += `<table><tr><th>Metric</th><th>Value</th></tr>`;
      data.stats.forEach(row => {
        html += `<tr><td>${row.metric}</td><td>${row.value}</td></tr>`;
      });
      html += `</table>`;

      tooltip.html(html)
        .style("left", (x + 10) + "px")
        .style("top", (y + 10) + "px")
        .style("display", "block");
    }

    svg.on("click", () => {
      tooltip.style("display", "none");
    });

    /* ------------------------------------------------------------------
       *  Dynamic data helpers – reuse existing Netlify functions
       * ----------------------------------------------------------------*/

    async function fetchCountryCodes(name) {
      try {
        const res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fields=cca2,cca3`);
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          return { iso2: data[0].cca2, iso3: data[0].cca3 };
        }
      } catch (err) {
        console.error('Error fetching country codes:', err);
      }
      return { iso2: null, iso3: null };
    }

    async function fetchAndPopulateCountryData(countryName) {
      const { iso2, iso3 } = await fetchCountryCodes(countryName);
      if (iso3) {
        await populateScorecardTabs(iso3);
      }
      if (iso2) {
        await populateNewsTab(iso2);
      }
    }

    async function populateScorecardTabs(iso3) {
      try {
        const res = await fetch(`/.netlify/functions/get-scorecard-data?iso=${iso3}`);
        const { rows = [] } = await res.json();

        // Categorise rows similar to original logic
        const overviewRows = rows.filter(r => { const id = parseInt(r.id); return !isNaN(id) && (id === 1 || id === 2 || id === 3 || id === 12); });
        const explainerRows = rows.filter(r => {
          const id = parseInt(r.id);
          return (r.id === null) || (!isNaN(id) && id === 6);
        });
        const trackerRows = rows.filter(r => {
          const id = parseInt(r.id);
          return !isNaN(id) && id >= 7 && id <= 11 && r.id !== "4";
        });

        // Helper to append rows to tbody following index.html rules exactly
        const addRows = (selection, dataRows, mode) => {
          selection.html("");
          dataRows.forEach(row => {
            if ((!row.label && !row.text) && (!row.html && !row.dHtml && !row.dText)) return;
            // Skip rules to mirror index.html behavior
            if (mode === 'explainer') {
              if ((!row.label && !row.text) || row.label === 'National\nCapabilities Map\n& Capability\nDirectory') {
                return;
              }
            }
            if (mode === 'tracker') {
              if (String(row.id) === '7') {
                return;
              }
            }
            const tr = selection.append("tr");

            let labelHtml = "-";
            let valueHtml = "-";

            if (mode === 'explainer') {
              // National Capabilities Map rules
              if (!row.id) {
                labelHtml = row.html || "";
                valueHtml = row.dHtml || row.dText || "";
              } else if (String(row.id) === '6') {
                labelHtml = row.label || row.text || "-";
                valueHtml = row.dText || row.text || "-";
              } else {
                labelHtml = row.label || row.text || "-";
                valueHtml = row.html || row.text || "-";
              }
            } else if (mode === 'tracker') {
              // Bioresilience Assessment rules
              labelHtml = row.label || row.text || "-";
              valueHtml = row.html || row.text || "-";
            } else {
              // Overview (default)
              labelHtml = row.label || row.text || "-";
              valueHtml = row.html || row.text || "-";
              // Special handling for resources row (id 12): split into links
              if (String(row.id) === '12' && row.text) {
                const urls = row.text.split('\n').filter(u => u.trim());
                valueHtml = urls.map(url => `<a href="${url}" target="_blank" rel="noopener noreferrer" style="display: block; margin: 5px 0;">${url}</a>`).join('');
              }
            }

            tr.append("th").html(labelHtml);
            tr.append("td").html(valueHtml);
          });
        };

        addRows(d3.select("#general-data-body"), overviewRows, 'overview');
        addRows(d3.select("#economy-data-body"), explainerRows, 'explainer');
        addRows(d3.select("#demographics-data-body"), trackerRows, 'tracker');
      } catch (err) {
        console.error('Error populating scorecard tabs:', err);
      }
    }

    async function populateNewsTab(iso2) {
      try {
        const res = await fetch(`/.netlify/functions/get-country-data?iso=${iso2}`);
        const data = await res.json();
        const table = d3.select("#health-table");
        const thead = table.select("thead");
        const tbody = d3.select("#health-data-body");
        tbody.html("");
        thead.html("");

        // Build header
        const headerRow = thead.append("tr");
        ["Date", "Disease", "Number of Locations", "Report Date"].forEach(h => {
          headerRow.append("th").text(h);
        });

        if (data && data.outbreaks && data.outbreaks.length) {
          data.outbreaks.forEach(ob => {
            const tr = tbody.append("tr");
            tr.append("td").text(ob.date);
            tr.append("td").text(ob.disease);
            tr.append("td").text(ob.numberOfLocations);
            tr.append("td").text(ob.reportDate);
          });
        } else {
          const tr = tbody.append("tr");
          tr.append("td").attr("colspan", 4).text("No outbreak data available for this country.");
        }
      } catch (err) {
        console.error('Error populating news tab:', err);
      }
    }

    // Function to fetch available ISOs from your Netlify function
    async function fetchAvailableIsos() {
      try {
        const response = await fetch('/.netlify/functions/get-available-isos');
        const data = await response.json();
        return data.isos || [];
      } catch (error) {
        console.error('Error fetching available ISOs:', error);
        return [];
      }
    }

    // Function to check if a country has data by comparing names to available ISOs
    function checkIfCountryHasData(countryName, availableIsos) {
      // Create a mapping of country names to ISO codes
      const countryToIsoMap = {
        "United States": "USA",
        "United States of America": "USA",
        "USA": "USA",
        "United Kingdom": "GBR", 
        "UK": "GBR",
        "Great Britain": "GBR",
        "Germany": "DEU",
        "Deutschland": "DEU",
        "France": "FRA",
        "Canada": "CAN",
        "Australia": "AUS",
        "Japan": "JPN",
        "Nippon": "JPN",
        "Italy": "ITA",
        "Italia": "ITA",
        "Spain": "ESP",
        "España": "ESP",
        "Netherlands": "NLD",
        "Holland": "NLD",
        "Switzerland": "CHE",
        "Schweiz": "CHE",
        "Sweden": "SWE",
        "Sverige": "SWE",
        "Norway": "NOR",
        "Norge": "NOR",
        "Denmark": "DNK",
        "Danmark": "DNK",
        "Finland": "FIN",
        "Suomi": "FIN",
        "Belgium": "BEL",
        "België": "BEL",
        "Austria": "AUT",
        "Österreich": "AUT",
        "Portugal": "PRT",
        "Greece": "GRC",
        "Ελλάδα": "GRC",
        "Poland": "POL",
        "Polska": "POL",
        "Czech Republic": "CZE",
        "Czechia": "CZE",
        "Hungary": "HUN",
        "Magyarország": "HUN",
        "Slovakia": "SVK",
        "Slovensko": "SVK",
        "Slovenia": "SVN",
        "Slovenija": "SVN",
        "Croatia": "HRV",
        "Hrvatska": "HRV",
        "Romania": "ROU",
        "România": "ROU",
        "Bulgaria": "BGR",
        "България": "BGR",
        "Estonia": "EST",
        "Eesti": "EST",
        "Latvia": "LVA",
        "Latvija": "LVA",
        "Lithuania": "LTU",
        "Lietuva": "LTU",
        "Ireland": "IRL",
        "Éire": "IRL",
        "Luxembourg": "LUX",
        "Lëtzebuerg": "LUX",
        "Malta": "MLT",
        "Cyprus": "CYP",
        "Κύπρος": "CYP",
        "Iceland": "ISL",
        "Ísland": "ISL",
        "New Zealand": "NZL",
        "South Korea": "KOR",
        "Korea": "KOR",
        "Singapore": "SGP",
        "Israel": "ISR",
        "South Africa": "ZAF",
        "Brazil": "BRA",
        "Brasil": "BRA",
        "Argentina": "ARG",
        "Chile": "CHL",
        "Mexico": "MEX",
        "México": "MEX",
        "India": "IND",
        "भारत": "IND",
        "China": "CHN",
        "中国": "CHN",
        "Thailand": "THA",
        "ประเทศไทย": "THA",
        "Malaysia": "MYS",
        "Indonesia": "IDN",
        "Philippines": "PHL",
        "Pilipinas": "PHL",
        "Vietnam": "VNM",
        "Việt Nam": "VNM",
        "Turkey": "TUR",
        "Türkiye": "TUR",
        "Ukraine": "UKR",
        "Україна": "UKR",
        "Russia": "RUS",
        "Россия": "RUS",
        "Kazakhstan": "KAZ",
        "Қазақстан": "KAZ",
        "Uzbekistan": "UZB",
        "O'zbekiston": "UZB",
        "Azerbaijan": "AZE",
        "Azərbaycan": "AZE",
        "Georgia": "GEO",
        "საქართველო": "GEO",
        "Armenia": "ARM",
        "Հայաստան": "ARM",
        "Moldova": "MDA",
        "Belarus": "BLR",
        "Беларусь": "BLR",
        "Albania": "ALB",
        "Shqipëria": "ALB",
        "North Macedonia": "MKD",
        "Macedonia": "MKD",
        "Montenegro": "MNE",
        "Crna Gora": "MNE",
        "Serbia": "SRB",
        "Србија": "SRB",
        "Bosnia and Herzegovina": "BIH",
        "Bosna i Hercegovina": "BIH",
        "Kosovo": "XKX"
      };
      
      // Try exact match first
      let isoCode = countryToIsoMap[countryName];
      
      // If no exact match, try case-insensitive match
      if (!isoCode) {
        const lowerCountryName = countryName.toLowerCase();
        for (const [key, value] of Object.entries(countryToIsoMap)) {
          if (key.toLowerCase() === lowerCountryName) {
            isoCode = value;
            break;
          }
        }
      }
      
      const hasData = isoCode ? availableIsos.includes(isoCode) : false;
      
      return hasData;
    }

    /* ------------------------------------------------------------------ */
  </script>

  <!-- TopoJSON script moved to head -->
</body>
</html>
